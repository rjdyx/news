function showEditPane(e,t,a,i,s){$("#edit-article").modal("show",{backdrop:"fade"}),$("#article_name").val(t),$("#main-nav").children().remove(),getMainNavs(a,i),$("#article_name").siblings("span").attr("id",e),setContent(e,s)}function showDeletePane(e,t){$("#delete-article strong").text(t),$("#delete-article strong").attr("id",e),$("#delete-article").modal("show",{backdrop:"fade"})}function init(){$(".tab-pane .deleteEnclosure").click(function(e){var t=$(this).siblings("span").attr("id");$("#delete-enclosure strong").text($(this).siblings("span").text()),$("#delete-enclosure strong").attr("id",t),$("#delete-enclosure").modal("show",{backdrop:"fade"})});UE.getEditor("editor",{autoFloatEnabled:!1,elementPathEnabled:!1,zIndex:9999})}function getNavsToEditMsg(){$.ajax({type:"GET",url:$.GetUrl()+"NavAction/getNavsToBackStage",dataType:"json",contentType:"application/json",success:function(e){for(var t="",a=2;a<e.length;a++)t+='<li class="dymNav">    <a href="#" onclick="'+(e[a].length>1?"getNavNewsByParent":"getNavNewsWithoutSubNav")+"("+e[a][0].priority+",'"+e[a][0].name+'\',this)">        <span class="title">'+e[a][0].name+"</span>    </a></li>";$("#listNav .dymNav").remove(),$("#listNav").append(t)},error:function(){toastr.error("连接失败")}})}function getMainNavs(e,t){if(e==t)var a=e;else var a=t;$.ajax({type:"GET",url:$.GetUrl()+"NavAction/getMainNavs",dataType:"json",contentType:"application/json",success:function(i){var s="";s+='<select class="form-control" onchange="getSubNavs()">',s+="<option "+(-2==a?'selected="selected"':"")+' value="-2">最新消息</option>',s+="<option "+(-3==a?'selected="selected"':"")+' value="-3">通知公告</option>',s+="<option "+(-4==a?'selected="selected"':"")+' value="-4">图片新闻</option>',s+="<option "+(-5==a?'selected="selected"':"")+' value="-5">常用管理系统</option>';for(var n=2;n<i.length;n++)s+="<option "+(i[n].priority==e?'selected="selected"':"")+' value="'+i[n].priority+'">'+i[n].name+"</option>";s+="</select>",$("#main-nav").append(s),getSubNavs(t)},error:function(){toastr.error("连接失败")}})}function getSubNavs(e){var t=$("#main-nav select option:selected").val();if($("#sub-nav select").remove(),-2>=t){var a="";return a+='<select class="form-control"><option value="'+t+'">无子栏目</option></select>',$("#sub-nav").append(a),!1}$.ajax({type:"GET",url:$.GetUrl()+"NavAction/getSubNavs",data:{parent:t},dataType:"json",success:function(t){var a="";a+='<select class="form-control">';for(var i=0;i<t.length;i++)a+="<option  "+(t[i].priority==e?'selected="selected"':"")+' value="'+t[i].priority+'">'+t[i].name+"</option>";0==t.length&&(a+='<option value="0" selected="selected">无子栏目</option>'),a+="</select>",$("#sub-nav").append(a)},error:function(){toastr.error("连接失败")}})}function getNews(){g_type=0,g_parent=-2,g_priority=-2,$("#listNav .active").attr("class",""),$("#indexNews").attr("class","active");var e='<div class="col-md-12"><ul class="nav nav-tabs nav-tabs-justified"><li class="active"><a href="#news" data-toggle="tab" onclick="showNews(1,-2,-2)"><span>最新消息</span></a></li><li><a href="#notice" data-toggle="tab" onclick="showNews(1,-3,-3)"><span>通知公告</span></a></li><li><a href="#guide" data-toggle="tab" onclick="showNews(1,-5,-5)"><span>常用管理系统</span></a></li><li><a href="#carouselPic" data-toggle="tab" onclick="showNews(1,-2,-4)"><span>滚动图片</span></a></li></ul><div class="tab-content"><div class="tab-pane active" id="news"><ul class="list-group list-group-minimal"></ul></div><div class="tab-pane" id="notice"><ul class="list-group list-group-minimal"></ul></div><div class="tab-pane" id="guide"><ul class="list-group list-group-minimal"></ul></div><div class="tab-pane" id="carouselPic"><ul class="list-group list-group-minimal"></ul></div></div></div>';$(".edit-article").children().remove(),$(".edit-article").append(e),showNews(1,-2,-2)}function showNews(e,t,a){g_parent=t,g_priority=a,$.ajax({type:"GET",url:$.GetUrl()+"NewsAction/pageNewsByParentAndPriority",data:{index:e,parent:t,priority:a},dataType:"json",success:function(e){for(var i="",s=0;s<e.newsList.length;s++)i+='<li class="list-group-item">    <i class="linecons-trash" onclick="showDeletePane(\''+e.newsList[s].id+"','"+e.newsList[s].title+'\')"></i>    <i class="linecons-pencil" onclick="showEditPane(\''+e.newsList[s].id+"','"+e.newsList[s].title+"',"+e.newsList[s].parent+","+e.newsList[s].priority+","+e.newsList[s].time+')"></i>    <span  id="'+e.newsList[s].id+'" class="'+e.newsList[s].parent+"_"+e.newsList[s].priority+"_"+e.newsList[s].time+'">'+e.newsList[s].title+"</span></li>";-1==t||-2==t?(-4==a&&($("#carouselPic ul").children().remove(),$("#carouselPic ul").append(i)),$("#news ul").children().remove(),$("#news ul").append(i)):-3==t?($("#notice ul").children().remove(),$("#notice ul").append(i)):-5==t?($("#guide ul").children().remove(),$("#guide ul").append(i)):($("#"+t+"-"+a+" ul").children().remove(),$("#"+t+"-"+a+" ul").append(i)),init(),$(".pagination").children().remove();var n="";e.begin>1&&(n+='<li><a href="#" onclick="showNews('+(e.index-1)+","+t+","+a+')">&laquo;</a></li><li><a href="#" onclick="showNews('+e.index+","+t+","+a+')">1...</a></li>');for(var s=e.begin;s<=e.end;s++)n+=" <li "+(s==e.index?'class="active"':"")+'><a href="#" onclick="showNews('+s+","+t+","+a+')">'+s+"</a></li>";e.end<e.pageCount&&(n+='<li><a href="#" onclick="showNews('+e.pageCount+","+t+","+a+')">...${pageCount}</a></li><li><a href="#" onclick="showNews('+(e.index+1)+","+t+","+a+')">&raquo;</a></li>'),n+='<li><a href="#">第'+e.index+"/"+e.pageCount+"页</a></li>",$(".pagination").append(n)},error:function(){toastr.error("连接失败")}})}function getDefaultNews(e){g_type=1,g_parent=-1,g_priority=-1,null!=e&&($("#listNav .active").attr("class",""),e.parentNode.setAttribute("class","active")),$.ajax({type:"GET",url:$.GetUrl()+"NewsAction/getNewsByParent",data:{parent:-1},dataType:"json",success:function(e){var t='<div class="col-md-12"><ul class="nav nav-tabs nav-tabs-justified"><li class="active"><a href="#news" data-toggle="tab"><span></span></a></li></ul><div class="tab-content"><div class="tab-pane active" id="news"><ul class="list-group list-group-minimal"></ul></div><div class="tab-pane" id="notice"><ul class="list-group list-group-minimal"></ul></div><div class="tab-pane" id="guide"><ul class="list-group list-group-minimal"></ul></div></div></div>';$(".edit-article").children().remove(),$(".edit-article").append(t),showNews(1,-1,-1)},error:function(){toastr.error("连接失败")}})}function setContent(e,t){$.ajax({type:"GET",url:$.GetUrl()+"NewsAction/getOneNews",data:{id:e},dataType:"json",success:function(e){UE.getEditor("editor").setContent(e.content,!1);var a=new Date;a.setTime(t),$("#article_date").val(a.getFullYear()+"-"+(a.getMonth()>8?"":"0")+(a.getMonth()+1)+"-"+a.getDate())},error:function(){toastr.error("连接失败")}})}function saveChange(){$.ajax({type:"POST",url:$.GetUrl()+"NewsAction/modifyNews",data:{id:$(".newsId").attr("id"),title:$("#article_name").val(),content:UE.getEditor("editor").getContent(),pic:$("input:checkbox[name=flag]:checked").parent().siblings()[0].outerHTML,parent:$("#main-nav select option:selected").val(),priority:$("#sub-nav select option:selected").val(),time:$("#article_date").val()},dataType:"json",success:function(e){if("1"==e)switch(g_type){case 0:showNews(1,g_parent,g_priority);break;case 1:getDefaultNews();break;case 2:showNews(1,g_parent,g_priority);break;case 3:getNavNewsWithoutSubNav(g_parent);break;case 4:searchNews(g_index)}},error:function(){toastr.error("连接失败")}})}function saveChangeWithoutPic(){$.ajax({type:"POST",url:$.GetUrl()+"NewsAction/modifyNews",data:{id:$(".newsId").attr("id"),title:$("#article_name").val(),content:UE.getEditor("editor").getContent(),parent:$("#main-nav select option:selected").val(),priority:$("#sub-nav select option:selected").val(),time:$("#article_date").val()},dataType:"json",success:function(e){if("1"==e)switch(g_type){case 0:showNews(1,g_parent,g_priority);break;case 1:getDefaultNews();break;case 2:showNews(1,g_parent,g_priority);break;case 3:getNavNewsWithoutSubNav(g_parent);break;case 4:searchNews(g_index)}},error:function(){toastr.error("连接失败")}})}function getNavNewsByParent(e,t,a){null!=a&&($("#listNav .active").attr("class",""),a.parentNode.setAttribute("class","active")),$.ajax({type:"GET",url:$.GetUrl()+"NewsAction/getNavNewsByParent",data:{parent:e},dataType:"json",success:function(e){var t="",a="",i="",s=0,n=0,l=0;t+='<div class="col-md-12"><ul class="nav nav-tabs nav-tabs-justified">';for(var r=0;r<e.length;r++)e[r].parent!=s||e[r].priority!=n?(0!=l&&(i+="</ul></div>"),a+="<li "+(0==r?'class="active"':"")+'>    <a href="#'+e[r].parent+"-"+e[r].priority+'" data-toggle="tab"  onclick="showNews(1,'+e[r].parent+","+e[r].priority+')">      <span>'+e[r].name+"</span>    </a></li>",i+='<div class="tab-pane '+(0==l?"active":"")+'" id="'+e[r].parent+"-"+e[r].priority+'"><ul class="list-group list-group-minimal"><li class="list-group-item">',i+="undefined"==typeof e[r].title?"<span></span></li>":'    <i class="linecons-trash" onclick="showDeletePane(\''+e[r].newsId+"','"+e[r].title+'\')"></i>    <i class="linecons-pencil" onclick="showEditPane(\''+e[r].newsId+"','"+e[r].title+"',"+e[r].parent+","+e[r].priority+","+e[r].time+')"></i>  <span id="'+e[r].newsId+'" class="'+e[r].parent+"_"+e[r].priority+"_"+e[r].time+'">'+e[r].title+"</span></li>",s=e[r].parent,n=e[r].priority,l=1):i+='<li class="list-group-item">    <i class="linecons-trash" onclick="showDeletePane(\''+e[r].newsId+"','"+e[r].title+'\')"></i>    <i class="linecons-pencil" onclick="showEditPane(\''+e[r].newsId+"','"+e[r].title+"',"+e[r].parent+","+e[r].priority+","+e[r].time+')"></i>  <span id="'+e[r].newsId+'" class="'+e[r].parent+"_"+e[r].priority+"_"+e[r].time+'">'+e[r].title+"</span></li>";t+=a+'</ul><div class="tab-content">'+i+"</ul></div></div></div>",$(".edit-article").children().remove(),$(".edit-article").append(t),g_type=2,g_parent=e[0].parent,g_priority=e[0].priority,showNews(1,e[0].parent,e[0].priority)},error:function(){toastr.error("连接失败")}})}function getNavNewsWithoutSubNav(e,t,a){null!=a&&($("#listNav .active").attr("class",""),a.parentNode.setAttribute("class","active")),$.ajax({type:"GET",url:$.GetUrl()+"NewsAction/getNewsByParent",data:{parent:e},dataType:"json",success:function(t){var a="";a+='<div class="col-md-12"><ul class="nav nav-tabs nav-tabs-justified"><li class="active">    <a href="#" data-toggle="tab">      <span>无子栏目</span>    </a></li></ul><div class="tab-content"><div class="tab-pane active"><ul class="list-group list-group-minimal">';for(var i=0;i<t.length;i++)a+='<li class="list-group-item">    <i class="linecons-trash" onclick="showDeletePane(\''+t[i].id+"','"+t[i].title+'\')"></i>    <i class="linecons-pencil" onclick="showEditPane(\''+t[i].id+"','"+t[i].title+"',"+t[i].parent+","+t[i].priority+","+t[i].time+')"></i>  <span id="'+t[i].id+'" class="'+t[i].parent+"_"+t[i].priority+"_"+t[i].time+'">'+t[i].title+"</span></li>";a+="</ul></div></div></div>",$(".edit-article").children().remove(),$(".edit-article").append(a),showNews(1,e,0),g_type=3,g_parent=e,g_priority=0},error:function(){toastr.error("连接失败")}})}function deleteNews(){var e=$(".deleteId").attr("id");$.ajax({type:"GET",url:$.GetUrl()+"NewsAction/deleteNews",data:{id:e},dataType:"json",success:function(e){if("1"==e)switch(g_type){case 0:showNews(1,g_parent,g_priority);break;case 1:getDefaultNews();break;case 2:showNews(1,g_parent,g_priority);break;case 3:getNavNewsWithoutSubNav(g_parent);break;case 4:searchNews(g_index)}},error:function(){toastr.error("连接失败")}})}function submitNews(){var e=$("#main-nav select option:selected").val();-4==e?($("#edit-modal").modal("show",{backdrop:"static"}),choosePic()):saveChangeWithoutPic()}function choosePic(){for(var e=UE.getEditor("editor").getContent(),t=new Array,a=0;;){e=e.substring(e.indexOf("<img"));var i=e.substring(0,e.indexOf("/>")+2);if(i.indexOf("width")>0,t[a++]=i,e=e.substring(e.indexOf("/>")+2),-1==e.indexOf("<img"))break}for(var s="",n=0;n<t.length;n++)s+='<div class="col-md-3 col-sm-4 col-xs-6">     <div class="album-image">',s+=t[n],s+='  <div class="image-checkbox">             <input type="checkbox" name="flag" />         </div>    </div>   </div>';$("#news-pic").children().remove(),$("#news-pic").append(s),console.log(1),$(":checkbox[name=flag]").each(function(){$(this).click(function(){$(this).prop("checked")&&($(":checkbox[name=flag]").removeProp("checked"),$(this).prop("checked","checked"),$("#submitPicNews").removeClass("disabled")),$(this).prop("checked")||$("#submitPicNews").addClass("disabled")})})}function searchNews(e){return g_type=4,g_index=e,""==$("#searchName").val()?(getNews(),!1):void $.ajax({type:"GET",url:$.GetUrl()+"FloatPicAction/searchNews",data:{index:e,name:$("#searchName").val()},dataType:"json",success:function(e){$(".edit-article").children().remove();for(var t='<div class="col-md-12"><ul class="nav nav-tabs nav-tabs-justified"><li class="active"><a href="#result" data-toggle="tab"><span>搜索结果</span></a></li></ul><div class="tab-content"><div class="tab-pane active" id="result"><ul class="list-group list-group-minimal">',a=0;a<e.newsList.length;a++)t+='<li class="list-group-item">    <i class="linecons-trash" onclick="showDeletePane(\''+e.newsList[a].id+"','"+e.newsList[a].title+'\')"></i>    <i class="linecons-pencil" onclick="showEditPane(\''+e.newsList[a].id+"','"+e.newsList[a].title+"',"+e.newsList[a].parent+","+e.newsList[a].priority+","+e.newsList[a].time+')"></i>    <span  id="'+e.newsList[a].id+'" class="'+e.newsList[a].parent+"_"+e.newsList[a].priority+"_"+e.newsList[a].time+'">'+e.newsList[a].title+"</span></li>";t+="</ul></div></div></div>",$(".edit-article").append(t),$(".pagination").children().remove(),t="",e.begin>1&&(t+='<li><a href="#" onclick="searchNews('+(e.index-1)+')">&laquo;</a></li><li><a href="#" onclick="searchNews('+e.index+')">1...</a></li>');for(var a=e.begin;a<=e.end;a++)t+=" <li "+(a==e.index?'class="active"':"")+'><a href="#" onclick="searchNews('+a+')">'+a+"</a></li>";e.end<e.pageCount&&(t+='<li><a href="#" onclick="searchNews('+e.pageCount+')">...${pageCount}</a></li><li><a href="#" onclick="searchNews('+(e.index+1)+')">&raquo;</a></li>'),t+='<li><a href="#">第'+e.index+"/"+e.pageCount+"页</a></li>",$(".pagination").append(t),init()},error:function(){toastr.error("连接失败")}})}function checkTitle(){""==$("#article_name").val()?$("#submitBtn").addClass("disabled"):$("#submitBtn").removeClass("disabled")}var g_type=0,g_parent=-2,g_priority=-2,g_index=1;jQuery.GetUrl=function(){var e=window.location.pathname.split("/");return"static"==e[1]||e[1].indexOf("Action")>0?"/":"/"+e[1]+"/"},$(function(){getNavsToEditMsg(),getNews(),$(".datepicker").cxCalendar()});